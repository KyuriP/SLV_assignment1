---
title: "SLV Assignment1"
author: 
- Daniel Anadria
- Kyuri Park 
- Ernst-Paul Swens
- Emilia Loescher
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  pdf_document:
    latex_engine: xelatex
  html_document:
    toc: true
    toc_float: true
geometry: "left = 2cm, right = 2cm, top = 2cm, bottom = 2cm"
# mainfont: Georgia
# sansfont: Georgia
---
<style type="text/css">
@import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400&display=swap');

body{ /* Normal  */
  font-size: 13px;
  font-family: 'Lato', sans-serif;
  }
h1.title {
  font-size: 25px;
  color: DarkBlue;
  margin-bottom:5px;
}
.author{
  display: inline-block;
  padding: 5px;
}
h1 { /* Header 1 */
  font-size: 20px;
  font-weight: bold;
}
h2 { /* Header 2 */
  font-size: 15px;
  line-height: 1.6;
}
h3 { /* Header 3 */
  font-size: 14px;
  line-height: 1.6;
}
pre { /* Code block - determines code spacing between lines */
  font-size: 13px;
}
td {  /* Table  */
  font-size: 12px;
}
</style>
<hr>

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
               warning = FALSE,
               comment = NA)

```

# Introduction

## The Dataset

We explore a dataset from [kaggle](https://www.kaggle.com/datasets/tangelus/housing-data-in-italy-august-2022?resource=download), which contains information about the housing market in Italy.
The data were scraped from one of the most relevant housing sales websites in Italy during the month of *August 2022*. The data consist of more than 223,000 sales posts spread over 7,023 (89% of the total 7,904) Italian municipalities (*comuni*).
Some of the entries were removed in dataset construction due to translation limitations (e.g., extended text-based description, specific url of the post). 

In order to plot the statistics of interest to maps of Italy, we use the regional and provincial shape files which we obtained from [the Italian National Institute of Statistics] (https://www.istat.it/it/archivio/222527). 
These files contain the regional and provincial coding and geographical shape information which can be used cluster the [comuni](https://en.wikipedia.org/wiki/Comune) in our data (`location`) into (107) provinces and (20) regions. 

For each sale, the dataset contains the following variables:

| Variable            | Description                    |
| :------------------ | :------------------------------|
|id                   | ID of the sale                               |
|timestamp            | Timestamp consisting of 10 digits                               |
|location             | Location on municipality level                               |
|title                |  Short description of property                              |
|price                |  Price in Euros                              |
|n_rooms              | Number of rooms                               |
|floor                | Floor                              |
|mq                   |       Size in square meters                         |
|n_bathrooms          |   Number of bathrooms                             |
|year_of_construction | Year of construction                               |
|availability         | Availability of property                             |
|energy_class         | Energy class ranging from a+ to g                               |
|status               |   Status of the property                             |
|heating              |    Type of heating                             |
|has_garage           | Garage present: yes (1), no (0)                              |
|has_terrace          |   Terrace present: yes (1), no (0)                             |
|has_garden           | Garden present: yes (1), no (0)                               |
|has_balcony          | Balcony present: yes (1), no (0)                               |
|has_fireplace        |  Fireplace present: yes (1), no (0)                              |
|has_alarm            |  Alarm present: yes (1), no (0)                              |
|has_air_conditioning | Air Conditioning present: yes (1), no (0)                               |
|has_pool             | Pool present: yes (1), no (0)                               |
|has_parking          | Parking present: yes (1), no (0)                               |
|has_elevator         | Elevator present: yes (1), no (0)                               |
|is_furnished         | Furniture present: yes (1), no (0)                               |
Table: Description of variables



## Exploratory Questions

We focus on four exploratory questions concerning housing prices in Italy.\

\textbf{Firstly}, we explore if there are a geographical trends in the mean and median housing prices in Italy. (E.g., Is housing more/less expensive in Northern Italy compared to Southern Italy?) \

\textbf{Secondly}, we examine if there are differences in mean regional variances of housing prices between the different provinces and regions. 

\textbf{Thirdly}, we explore if there is a correlation between the missingness of housing price and other variables. \

\textbf{Fourthly}, we identify the most important predictors of housing prices in Italy. \


# Preparation

In order to start our exploratory analysis, we first load relevant packages and import the full data set. 

## Load Packages & Import Data

```{r, warning=F, message=F}
# load packages
library(tidyverse) # for wrangling data
library(skimr) # for skimming data 
library(sf) # for spatial analysis
library(sp) # for spatial analysis
library(ggplot2) # for plotting
library(fuzzyjoin) # for joining on not-exact matches

# import data
housing <- read.csv("data/housing_data_italy_august2022.csv", na.strings=c("","NA"), header = TRUE)

# import shape files
munic_2022 <- st_read("data/italy_shape_2022_files/Com01012022_g")[c("COD_REG","COD_PROV", "COMUNE")]  # municipality level
prov_2022 <- st_read("data/italy_shape_2022_files/ProvCM01012022_g") # province level
reg_2022 <- st_read("data/italy_shape_2022_files/Reg01012022_g") # region level
```

## Preliminary analysis

We skim through our data using the `skimr` package.  
The original data consist of 223,409 rows (sales) and 25 columns (variables).
Given our questions, we conclude that `id` (ID of the sale) `timestamp` (timestamp of the sale) and `title` (description of the property) are irrelevant and, hence, we exclude them from the dataset for further analysis.
In addition, we remove two columns that have only one unique value (`status`: "other" and `availibility`: "not free/other"), as these variables do not provide information specific to certain sales.

Furthermore, we observe that types of some variables are wrongly specified. We convert them to a correct type (e.g., `heating`: character --> factor, `has_xxx`: numeric --> factor, `is_furnished`: numeric --> factor).\

We create a new variable `age` which contains the age of the property in 2022 by subtracting the `year_of_construction` from 2022. In the original dataset, there are some unreasonable years of construction (e.g. 2209). Thus, we set `age` to NA for any `year_of_construction` further in the future from 2026. Some property may be sold before construction is completed, but we deem it unlikely for properties whose `year_of_construction` is more than 4 years removed from the present year.


```{r}
housing_red <- housing %>% 
  #For model building exclude the following variables:
  # select variables that have more than one unique value
  select(where(~n_distinct(.) > 1)) %>% 
  # remove timestamp and title
  select(-c(id, timestamp, title)) %>% 
  # fix the data type
  mutate(across(c(starts_with("has"), is_furnished, heating), factor)) %>%
  #Setting "year_of_construction" > 2026 to NA
  mutate(year_of_construction = replace(year_of_construction, year_of_construction > 2026, NA)) %>%
  #Transforming "year_of_construction" in age (2022-year of construction)
  mutate(age = 2022 - as.numeric(year_of_construction)) %>% 
  # Removing "year_of_construction"
  select(-year_of_construction)
```


After the modification of the data, we take a look at the summary statistics for the data set to get a better overview of our data. 

```{r}
# round up by 2 decimal places + disable scientific notation
options(digits = 2, scipen = 999) 
# specify skimming function
my_skim <- skim_with(character = sfl(whitespace=NULL, min = NULL, max = NULL),
                     factor = sfl(ordered = NULL, top_counts = NULL, "ratio (autonomous or 1)" = ~(sum(. == 1 ) + sum(. == "autonomous"))/length(.)),
                     
                     numeric = sfl(p0 = NULL, p25=NULL, p50=NULL, p75=NULL,
                                   p100=NULL, hist=NULL, median = ~median(., na.rm=T), 
                                   min = ~min(., na.rm=T), max = ~max(., na.rm=T), n_unique=n_unique))
# skim the data
my_skim(housing_red) 

```

From the tables, we can see that there are 12 different energy classes and 7023 different locations. When taking a closer look at the `location` variable, one can see that they are given on a municipality level. 

Regarding the factor variables, we see that there are no missing values. The ratio of properties with an alarm is the lowest with 1\% and the highest for air conditioning (30\%). 90\% of buildings have autonomous heating. 

For the numeric variables, we observe that several have lots of missing values (e.g., `price`, `n_rooms`, `floor`, `mq`, `n_bathrooms`). We will discuss how we want to deal with this in section \ref{ref:missingness}. 

**Discuss price descriptives, many outliers, deal with them**
**include other plots, density, boxplot, etc.**
**make the plots color-blind friendly**
**name chunks, use cache = T on the final version**
# Exploratory Analysis

## Question 1: Geographical Differences in the Mean and Median Housing Price

Each sale in our dataset is assigned to one of 7023 municipalities. 
In order to create plots which visualize the differences in average housing prices across Italy, we assign each municipality (*comune*) to its corresponding province (*provincia*) and region (*regione*). We use the data from the *Italian National Institute of Statistics* (*ISTAT*) to append the province and region information to every observed municipality in our dataset. 

### Preparation

At the beginning of the assignment, we loaded the *ISTAT* shape files. These files are useful for two reasons.
First, they contain the list of all Italian municipalities, their respective provinces and regions.
Therefore, we can use this data to append our original dataset with additional location indicators.
Second, they contain the shapes of Italy divided into provinces and regions. 
This is particularly useful for creating map plots using `ggplot2`.

For completeness of our dataset, we append the province and region information.
We use fuzzy matching for inexact matches as we found that there were some minor inconsistencies in how the municipalities were named in our dataset as opposed to their names in the ISTAT shape files. The result of the following chunk of code is that all the municipalities are assigned their regions and provinces.

```{r}
housing_red <- stringdist_left_join(housing_red, munic_2022,by = c("location" = "COMUNE"), distance_col = "distance",ignore_case = T) %>% 
  group_by(location) %>% slice_min(distance) %>%
  select(-geometry,-distance) %>% 
  left_join(., as.data.frame(reg_2022[,c("COD_REG","DEN_REG")])) %>% 
  select(-geometry, -COMUNE) %>% 
  left_join(., as.data.frame(prov_2022[,c("DEN_UTS", "COD_PROV")], by = "COD_PROV")) %>% 
  select(-geometry, -COD_REG, -COD_PROV) %>% 
  rename(., "region" = "DEN_REG", "province" = "DEN_UTS") %>% 
  relocate(c(region, province), .after=location)
```

To answer the first exploratory question, we aggregate our data on two levels: 1) regional and 2) provincial level by computing two aggregate statistics: 1) the mean housing price and 2) the variance in housing price on the two respective levels. This yields two datasets, one per aggregation level. To each, we attach geometric information needed for plotting and convert it to an `sf` object which is a requirement for plotting maps.

```{r price_by_reg}
price_by_reg <- housing_red %>% group_by(region) %>% 
  summarize(mean = mean(price, na.rm=T), median = median(price, na.rm=T), variance = var(price, na.rm=T), mad = mad(price,na.rm=T)) %>% left_join(.,reg_2022, by = c("region" = "DEN_REG")) %>% st_as_sf()
```

```{r price_by_prov}
price_by_prov <- housing_red %>% group_by(province) %>% 
  summarize(mean = mean(price, na.rm=T), median = median(price, na.rm=T), variance = var(price, na.rm=T), mad = mad(price, na.rm=T)) %>% left_join(.,prov_2022, by = c("province" = "DEN_PROV")) %>% st_as_sf()
```

### Plot

We inspect the mean housing price by region. 

```{r}
ggplot(price_by_reg) +
  geom_sf(aes(fill = mean))+  
  ggtitle("Mean House Price by Region") +
  theme_minimal()
```

We inspect the average housing price by province. 

```{r}
ggplot(price_by_prov) +
  geom_sf(aes(fill = mean))+
  ggtitle("Mean House Price by Province") +
  theme_minimal()
```


We inspect the median housing price by region. 

```{r}
ggplot(price_by_reg) +
  geom_sf(aes(fill = median))+
  ggtitle("Median House Price by Region") +
  theme_minimal()
```

We inspect the median housing price by province. 

```{r}
ggplot(price_by_prov) +
  geom_sf(aes(fill = median))+
  ggtitle("Median House Price by Province") +
  theme_minimal()
```

### Conclusion


## Question 2: Geographical Differences in Variance and Median Absolute Deviation of Housing Prices

### Preparation



### Plot

We inspect the housing price variance by region. 

```{r}
ggplot(price_by_reg) +
  geom_sf(aes(fill = variance))+
  ggtitle("House Price Variance by Region") +
  theme_minimal()
```


We inspect the housing price variance by province. 

```{r}
ggplot(price_by_prov) +
  geom_sf(aes(fill = variance))+
  ggtitle("House Price Variance by Province") +
  theme_minimal()
```
We inspect the median absolute deviation of housing price by region.

```{r}
ggplot(price_by_reg) +
  geom_sf(aes(fill = mad))+
  ggtitle("House Price Median Absolute Deviation by Region") +
  theme_minimal()
```


We inspect the median absolute deviation of housing price by province.

```{r}
ggplot(price_by_prov) +
  geom_sf(aes(fill = mad))+
  ggtitle("House Price Median Absolute Deviation by Province") +
  theme_minimal()
```

### Conclusion



## Question 3: Missingness and Imputation  \label{ref:missingness}
-  ***Plot the missingness to see if there is any pattern for NA vs non-NA, correlation, imputation ***

### Preparation


### Plots



### Conclusion


## Question 4: Relevant Predictors for Housing Price

### Preparation



### Analysis



### Conclusion




# Overall Conclusion





